language: minimal

services:
  - docker

env:
  global:
    - DOCKER_ORG_NAME=tidair
    - DOCKER_REPO=smurf2mce

stages:
  - name: deploy_docker
    if: tag IS present

jobs:
  include:
    - stage: deploy_docker
      name: "Deploy Docker Image"
      before_script:
        # Use the git tag to tag tag docker image
        - export DOCKER_TAG=`git describe --tags --always`
        # Login to docker
        - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_ORG_NAME}" --password-stdin;

      script:
        # Build the docker image
        - docker build -t ${DOCKER_ORG_NAME}/${DOCKER_REPO} .

      after_success:
        # Upload docker image (as tagged and latest version)
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO};
        - docker tag ${DOCKER_ORG_NAME}/${DOCKER_REPO} ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - echo "Docker image '${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG}' pushed"

notifications:
  slack:
    secure: oli9EB4jRKSXsmbDvUMwPBDHuFWKs1pEmCYaZZk2jwsBnxOpGngVayEtHbuodjqw3ZN3WtxlteIQqZdh01TRR6Z3Iny4o6Vh8/5IUVt3W9yPtPplq6x16PTlSj+RxiMuqTpuyD8TJRvFGpal9IZG/R0MpbJPvMH6SwEuaadN92s1JWZs9Ag8LVFypNgteLmW4+moRH6oUblSdmrv4aRXQBGtd6G5jURWJNayGFGPxiIQyi0viaOJsf4rCzM8QDFmiyT6OwJGF7Tb5C+oYBbK10IpyZ9ocp3RM6OIOSqsZD8ia+4Vr8tckpFQh5utnXzcvcjjWh7kEIS3MqoI3Z1PfmYt0B6r9jDGSrAT18qV4hyBOAqiN83XTX7L3c37orohZsHIo1/dCwx7PKDGQEMqoOcovSIgWurp+Nhf0UviBdBuJ5kMuoE7AKoaETfa1VRBxbpH8ELrhkh91vMWXeOkbrbIXddeazWR7C00PDUJsAO6unrNeUzEgmcZlSEDeXlZLmR3Zt5uO+384RA4sGe0JRM/lUY9i1yXVmXgTQJmZVaFi6npo0DT+uKJA2/mxJoxoxWgB4wKVBx0JK1mEMjze5MxF4W8zabZK+sr8GbbavqJ/M8I6pfcTmb/GeeCA1DeqKr7WnoVybMixvkAXTHVGHmdzTaS1NeCYgwi5hq356A=
